<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test du Système de Suivi</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Test du Système de Suivi des Réclamations</h1>
    
    <div class="test-section">
        <h2>Test de l'API de Suivi</h2>
        <p>Entrez un numéro de référence pour tester le suivi :</p>
        <input type="text" id="test-reference" placeholder="Ex: TT-1001" value="TT-1001">
        <button onclick="testTracking()">Tester le Suivi</button>
        <button onclick="testErrorCase()">Tester Cas d'Erreur</button>
        <div id="result"></div>
    </div>

    <div class="test-section">
        <h2>Test des Fonctions JavaScript</h2>
        <button onclick="testFormatDate()">Tester formatDate()</button>
        <button onclick="testGenerateStatusTimeline()">Tester generateStatusTimeline()</button>
        <button onclick="testGenerateComplaintDetails()">Tester generateComplaintDetails()</button>
    </div>

    <div class="test-section">
        <h2>Logs de Console</h2>
        <button onclick="clearConsole()">Vider la Console</button>
        <div id="console-output" style="background: #f8f9fa; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        // Configuration de l'API
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        
        // Fonction pour logger dans notre console personnalisée
        function log(message, type = 'info') {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'};">${message}</span>`;
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Aussi dans la console du navigateur
            console.log(`[${timestamp}] ${message}`);
        }

        // Test de l'API de suivi
        async function testTracking() {
            const reference = document.getElementById('test-reference').value.trim();
            if (!reference) {
                showResult('Veuillez entrer un numéro de référence', 'error');
                return;
            }

            log(`Test de suivi pour la référence: ${reference}`, 'info');
            showResult('Test en cours...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/complaints/track/${reference}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`Succès: Réclamation trouvée`, 'success');
                    showResult(`Succès! Réclamation trouvée: ${data.complaint.subject}`, 'success');
                    
                    // Tester les fonctions de génération
                    testGenerateStatusTimeline(data.complaint);
                    testGenerateComplaintDetails(data.complaint);
                } else {
                    log(`Erreur: ${data.message}`, 'error');
                    showResult(`Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Erreur de connexion: ${error.message}`, 'error');
                showResult(`Erreur de connexion: ${error.message}`, 'error');
            }
        }

        // Test du cas d'erreur
        async function testErrorCase() {
            log('Test du cas d\'erreur avec une référence invalide', 'info');
            showResult('Test du cas d\'erreur...', 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/complaints/track/INVALID-REF`);
                const data = await response.json();
                
                if (!response.ok) {
                    log(`Cas d'erreur géré correctement: ${data.message}`, 'success');
                    showResult(`Cas d'erreur géré correctement: ${data.message}`, 'success');
                } else {
                    log(`Attention: Réponse inattendue pour référence invalide`, 'error');
                    showResult(`Attention: Réponse inattendue pour référence invalide`, 'error');
                }
            } catch (error) {
                log(`Erreur de connexion: ${error.message}`, 'error');
                showResult(`Erreur de connexion: ${error.message}`, 'error');
            }
        }

        // Test de la fonction formatDate
        function testFormatDate() {
            log('Test de la fonction formatDate()', 'info');
            
            const testDates = [
                '2024-01-15T10:30:00Z',
                '2024-01-15T14:45:00Z',
                null,
                'invalid-date'
            ];

            testDates.forEach(date => {
                try {
                    const formatted = formatDate(date);
                    log(`formatDate('${date}') = '${formatted}'`, 'success');
                } catch (error) {
                    log(`formatDate('${date}') = ERREUR: ${error.message}`, 'error');
                }
            });
        }

        // Test de la fonction generateStatusTimeline
        function testGenerateStatusTimeline(complaint) {
            if (!complaint) {
                log('Test generateStatusTimeline: Aucune réclamation fournie', 'error');
                return;
            }

            log('Test de la fonction generateStatusTimeline()', 'info');
            
            try {
                // Créer un conteneur temporaire pour le test
                const tempContainer = document.createElement('div');
                tempContainer.id = 'temp-timeline';
                document.body.appendChild(tempContainer);
                
                // Simuler la fonction
                const timeline = tempContainer;
                timeline.innerHTML = '';
                
                const statuses = ['Nouveau', 'En cours', 'Résolu', 'Fermé'];
                const currentStatus = complaint.status;
                
                statuses.forEach((status, index) => {
                    const step = document.createElement('div');
                    step.className = 'status-step';
                    
                    let icon, statusText;
                    switch (status) {
                        case 'Nouveau':
                            icon = 'fas fa-file-alt';
                            statusText = 'Soumis';
                            break;
                        case 'En cours':
                            icon = 'fas fa-cog';
                            statusText = 'En traitement';
                            break;
                        case 'Résolu':
                            icon = 'fas fa-check-circle';
                            statusText = 'Résolu';
                            break;
                        case 'Fermé':
                            icon = 'fas fa-times-circle';
                            statusText = 'Fermé';
                            break;
                    }
                    
                    if (status === currentStatus) {
                        step.classList.add('active');
                    } else if (statuses.indexOf(status) < statuses.indexOf(currentStatus)) {
                        step.classList.add('completed');
                    }
                    
                    step.innerHTML = `
                        <div class="status-icon">
                            <i class="${icon}"></i>
                        </div>
                        <h4>${statusText}</h4>
                        <span>${getStatusDate(complaint, status)}</span>
                    `;
                    
                    timeline.appendChild(step);
                });
                
                log(`Timeline générée avec ${timeline.children.length} étapes`, 'success');
                
                // Nettoyer
                document.body.removeChild(tempContainer);
            } catch (error) {
                log(`Erreur dans generateStatusTimeline: ${error.message}`, 'error');
            }
        }

        // Test de la fonction generateComplaintDetails
        function testGenerateComplaintDetails(complaint) {
            if (!complaint) {
                log('Test generateComplaintDetails: Aucune réclamation fournie', 'error');
                return;
            }

            log('Test de la fonction generateComplaintDetails()', 'info');
            
            try {
                const details = [
                    { label: 'Référence', value: complaint.reference_id },
                    { label: 'Date de soumission', value: formatDate(complaint.created_at) },
                    { label: 'Type de réclamation', value: complaint.type },
                    { label: 'Sujet', value: complaint.subject },
                    { label: 'Priorité', value: complaint.priority || 'Normale' },
                    { label: 'Statut actuel', value: complaint.status }
                ];
                
                log(`Détails générés: ${details.length} champs`, 'success');
                details.forEach(detail => {
                    log(`  ${detail.label}: ${detail.value}`, 'info');
                });
            } catch (error) {
                log(`Erreur dans generateComplaintDetails: ${error.message}`, 'error');
            }
        }

        // Fonctions utilitaires (copiées de tracking.js)
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Date invalide';
            
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString('fr-FR', options);
        }

        function getStatusDate(complaint, status) {
            if (status === 'Nouveau') {
                return formatDate(complaint.created_at);
            }
            
            if (complaint.status_history) {
                const historyItem = complaint.status_history.find(h => h.new_status === status);
                if (historyItem) {
                    return formatDate(historyItem.created_at);
                }
            }
            
            return '-';
        }

        // Affichage des résultats
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = type;
        }

        // Vider la console
        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('Page de test chargée', 'success');
            log('API_BASE_URL: ' + API_BASE_URL, 'info');
        });
    </script>
</body>
</html>
