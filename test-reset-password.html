<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Reset Password</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; }
        .url-display { background: #f8f9fa; padding: 10px; margin: 10px 0; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body>
    <h1>Test du Système de Reset Password</h1>
    
    <div class="test-section">
        <h2>1. Test de l'URL de Reset</h2>
        <p>Vérifiez que l'URL générée pointe vers le bon frontend :</p>
        <div class="url-display" id="url-display">
            URL attendue: http://127.0.0.1:5500/reset-password.html?token=...&email=...
        </div>
        <button onclick="testUrlGeneration()">Tester la Génération d'URL</button>
    </div>

    <div class="test-section">
        <h2>2. Test de l'API Forgot Password</h2>
        <p>Testez l'envoi d'email de réinitialisation :</p>
        <input type="email" id="test-email" placeholder="Email à tester" value="zmamine024@gmail.com">
        <button onclick="testForgotPassword()">Tester Forgot Password</button>
        <div id="forgot-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test de l'API Reset Password</h2>
        <p>Testez la réinitialisation avec un token :</p>
        <input type="text" id="test-token" placeholder="Token de test" value="test-token-123">
        <input type="email" id="reset-email" placeholder="Email" value="zmamine024@gmail.com">
        <input type="password" id="new-password" placeholder="Nouveau mot de passe" value="newpassword123">
        <input type="password" id="confirm-password" placeholder="Confirmer mot de passe" value="newpassword123">
        <button onclick="testResetPassword()">Tester Reset Password</button>
        <div id="reset-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Test de Vérification de Token</h2>
        <p>Testez la vérification d'un token :</p>
        <input type="text" id="verify-token" placeholder="Token à vérifier" value="test-token-123">
        <input type="email" id="verify-email" placeholder="Email" value="zmamine024@gmail.com">
        <button onclick="testVerifyToken()">Tester Vérification Token</button>
        <div id="verify-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Logs de Console</h2>
        <button onclick="clearConsole()">Vider la Console</button>
        <div id="console-output" style="background: #f8f9fa; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        // Configuration de l'API
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        const FRONTEND_URL = 'http://127.0.0.1:5500';
        
        // Fonction pour logger dans notre console personnalisée
        function log(message, type = 'info') {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'};">${message}</span>`;
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Aussi dans la console du navigateur
            console.log(`[${timestamp}] ${message}`);
        }

        // Test de la génération d'URL
        function testUrlGeneration() {
            log('Test de la génération d\'URL de reset', 'info');
            
            const testToken = 'test-token-123';
            const testEmail = 'zmamine024@gmail.com';
            
            const expectedUrl = `${FRONTEND_URL}/reset-password.html?token=${testToken}&email=${encodeURIComponent(testEmail)}`;
            
            document.getElementById('url-display').innerHTML = `
                <strong>URL générée:</strong><br>
                ${expectedUrl}<br><br>
                <strong>Vérification:</strong><br>
                ✅ Frontend URL: ${FRONTEND_URL}<br>
                ✅ Page: reset-password.html<br>
                ✅ Token: ${testToken}<br>
                ✅ Email: ${testEmail}
            `;
            
            log(`URL générée: ${expectedUrl}`, 'success');
        }

        // Test de l'API Forgot Password
        async function testForgotPassword() {
            const email = document.getElementById('test-email').value.trim();
            if (!email) {
                showResult('Veuillez entrer un email', 'error', 'forgot-result');
                return;
            }

            log(`Test de forgot password pour: ${email}`, 'info');
            showResult('Test en cours...', 'info', 'forgot-result');

            try {
                const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`Succès: Email envoyé à ${email}`, 'success');
                    showResult(`Succès! Email envoyé à ${email}`, 'success', 'forgot-result');
                } else {
                    log(`Erreur: ${data.message}`, 'error');
                    showResult(`Erreur: ${data.message}`, 'error', 'forgot-result');
                }
            } catch (error) {
                log(`Erreur de connexion: ${error.message}`, 'error');
                showResult(`Erreur de connexion: ${error.message}`, 'error', 'forgot-result');
            }
        }

        // Test de l'API Reset Password
        async function testResetPassword() {
            const token = document.getElementById('test-token').value.trim();
            const email = document.getElementById('reset-email').value.trim();
            const password = document.getElementById('new-password').value;
            const passwordConfirmation = document.getElementById('confirm-password').value;

            if (!token || !email || !password || !passwordConfirmation) {
                showResult('Tous les champs sont obligatoires', 'error', 'reset-result');
                return;
            }

            if (password !== passwordConfirmation) {
                showResult('Les mots de passe ne correspondent pas', 'error', 'reset-result');
                return;
            }

            log(`Test de reset password pour: ${email}`, 'info');
            showResult('Test en cours...', 'info', 'reset-result');

            try {
                const response = await fetch(`${API_BASE_URL}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        token,
                        email,
                        password,
                        password_confirmation: passwordConfirmation
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`Succès: Mot de passe réinitialisé pour ${email}`, 'success');
                    showResult(`Succès! Mot de passe réinitialisé pour ${email}`, 'success', 'reset-result');
                } else {
                    log(`Erreur: ${data.message}`, 'error');
                    showResult(`Erreur: ${data.message}`, 'error', 'reset-result');
                }
            } catch (error) {
                log(`Erreur de connexion: ${error.message}`, 'error');
                showResult(`Erreur de connexion: ${error.message}`, 'error', 'reset-result');
            }
        }

        // Test de vérification de token
        async function testVerifyToken() {
            const token = document.getElementById('verify-token').value.trim();
            const email = document.getElementById('verify-email').value.trim();

            if (!token || !email) {
                showResult('Token et email sont obligatoires', 'error', 'verify-result');
                return;
            }

            log(`Test de vérification de token pour: ${email}`, 'info');
            showResult('Test en cours...', 'info', 'verify-result');

            try {
                const response = await fetch(`${API_BASE_URL}/verify-reset-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ token, email })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const status = data.valid ? 'valide' : 'invalide';
                    log(`Token ${status} pour ${email}`, data.valid ? 'success' : 'error');
                    showResult(`Token ${status}: ${data.message}`, data.valid ? 'success' : 'error', 'verify-result');
                } else {
                    log(`Erreur: ${data.message}`, 'error');
                    showResult(`Erreur: ${data.message}`, 'error', 'verify-result');
                }
            } catch (error) {
                log(`Erreur de connexion: ${error.message}`, 'error');
                showResult(`Erreur de connexion: ${error.message}`, 'error', 'verify-result');
            }
        }

        // Affichage des résultats
        function showResult(message, type, elementId) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.textContent = message;
            resultDiv.className = type;
        }

        // Vider la console
        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('Page de test de reset password chargée', 'success');
            log('API_BASE_URL: ' + API_BASE_URL, 'info');
            log('FRONTEND_URL: ' + FRONTEND_URL, 'info');
            
            // Test automatique de la génération d'URL
            testUrlGeneration();
        });
    </script>
</body>
</html>
